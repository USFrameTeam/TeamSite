<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼  - USFrameTeam</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern_github_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='uploadfiles.css') }}">
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="header">
        <div class="team-info">
            <div class="logo-and-name">
                <a href="{{ url_for('index') }}" class="team-name">USFrameTeam</a>
            </div>
            <div class="header-actions">
                {% if current_user %}
                    <div class="user-info">
                        <img src="{{ current_user.avatar_url }}" alt="ç”¨æˆ·å¤´åƒ" class="user-avatar" width="32" height="32">
                        <span class="user-name">{{ current_user.name }}</span>
                        {% if current_user.is_team_member %}
                            <span class="team-badge">å›¢é˜Ÿæˆå‘˜</span>
                        {% elif current_user.is_special_user %}
                            <span class="special-badge">ç‰¹æ®Šç”¨æˆ·</span>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('logout') }}" class="github-link">é€€å‡º</a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="github-link">ç™»å½•</a>
                {% endif %}
                <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </div>
    </header>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="top-nav">
        <div class="nav-links">
            <a href="{{ url_for('index') }}" class="nav-link">é¦–é¡µ</a>
            <a href="{{ url_for('news_route') }}" class="nav-link">æ–°é—»</a>
            <a href="{{ url_for('download_route') }}" class="nav-link">ä¸‹è½½</a>
            <a href="{{ url_for('upload_page') }}" class="nav-link active">ä¸Šä¼ </a>
            <a href="{{ url_for('about') }}" class="nav-link">å…³äº</a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <div class="upload-container">
            <!-- æƒé™æç¤º -->
            {% if current_user and has_permission('ManageDownloadSite') %}
                <div class="permission-hint">
                    <div class="permission-hint-title">ğŸ“ æ–‡ä»¶ä¸Šä¼ æƒé™</div>
                    <div class="permission-hint-text">
                        æ‚¨å…·æœ‰æ–‡ä»¶ä¸Šä¼ æƒé™ï¼Œå¯ä»¥ä¸Šä¼ æ–‡ä»¶åˆ°ä¸‹è½½é¡µé¢ã€‚æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼šå›¾ç‰‡ã€æ–‡æ¡£ã€å‹ç¼©åŒ…ç­‰ã€‚
                    </div>
                </div>
            {% else %}
                <div class="permission-hint">
                    <div class="permission-hint-title">ğŸ”’ æƒé™ä¸è¶³</div>
                    <div class="permission-hint-text">
                        æ‚¨éœ€è¦å…·æœ‰æ–‡ä»¶ä¸Šä¼ æƒé™æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚è¯·è”ç³»å›¢é˜Ÿæˆå‘˜è·å–æƒé™ã€‚
                    </div>
                </div>
            {% endif %}

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            {% if current_user and has_permission('ManageDownloadSite') %}
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                    <div class="upload-hint">æ”¯æŒå•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ä¸Šä¼ ï¼Œæœ€å¤§æ–‡ä»¶å¤§å°ï¼š100MB</div>
                    <input type="file" id="fileInput" multiple style="display: none;">
                    <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                        é€‰æ‹©æ–‡ä»¶
                    </button>
                </div>

                <!-- çŠ¶æ€æ¶ˆæ¯ -->
                <div id="statusMessage" style="display: none;"></div>

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="file-list">
                    <div class="file-list-header">
                        <div class="file-list-title">å¾…ä¸Šä¼ æ–‡ä»¶</div>
                    </div>
                    <div id="fileListContainer">
                        <div class="empty-state" id="emptyState">
                            <div class="empty-state-icon">ğŸ“„</div>
                            <div>æš‚æ— å¾…ä¸Šä¼ æ–‡ä»¶</div>
                        </div>
                    </div>
                </div>

                <!-- ä¸Šä¼ æŒ‰é’® -->
                <div style="text-align: center; margin-top: var(--spacing-xl);">
                    <button class="upload-button" id="uploadButton" disabled onclick="uploadFiles()">
                        å¼€å§‹ä¸Šä¼ 
                    </button>
                </div>
            {% endif %}
        </div>
    </main>

    <script>
        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        });

        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³åŠŸèƒ½
        let selectedFiles = [];

        // æ‹–æ”¾åŠŸèƒ½
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function() {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });

        // å¤„ç†æ–‡ä»¶
        function handleFiles(files) {
            for (let file of files) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ100MBé™åˆ¶ï¼‰
                if (file.size > 100 * 1024 * 1024) {
                    showStatus('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡100MB: ' + file.name, 'error');
                    continue;
                }

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    showStatus('æ–‡ä»¶å·²å­˜åœ¨: ' + file.name, 'info');
                    continue;
                }

                selectedFiles.push(file);
            }
            updateFileList();
        }

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
        function updateFileList() {
            const container = document.getElementById('fileListContainer');
            const emptyState = document.getElementById('emptyState');
            const uploadButton = document.getElementById('uploadButton');

            if (selectedFiles.length === 0) {
                emptyState.style.display = 'block';
                container.innerHTML = '';
                uploadButton.disabled = true;
                return;
            }

            emptyState.style.display = 'none';
            
            let html = '';
            selectedFiles.forEach((file, index) => {
                const fileType = getFileType(file.name);
                const fileSize = formatFileSize(file.size);
                
                html += `
                    <div class="file-item">
                        <div class="file-type-icon ${fileType}">${getFileExtension(file.name)}</div>
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${fileSize}</div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action delete" onclick="removeFile(${index})">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            uploadButton.disabled = false;
        }

        // åˆ é™¤æ–‡ä»¶
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }

        // è·å–æ–‡ä»¶ç±»å‹
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
            const documentTypes = ['pdf', 'doc', 'docx', 'txt', 'md'];
            const archiveTypes = ['zip', 'rar', '7z', 'tar', 'gz'];
            const audioTypes = ['mp3', 'wav', 'ogg', 'flac'];
            const videoTypes = ['mp4', 'avi', 'mkv', 'mov'];

            if (imageTypes.includes(ext)) return 'image';
            if (documentTypes.includes(ext)) return 'document';
            if (archiveTypes.includes(ext)) return 'archive';
            if (audioTypes.includes(ext)) return 'audio';
            if (videoTypes.includes(ext)) return 'video';
            return 'document';
        }

        // è·å–æ–‡ä»¶æ‰©å±•å
        function getFileExtension(filename) {
            return filename.split('.').pop().toUpperCase();
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            const uploadButton = document.getElementById('uploadButton');
            uploadButton.disabled = true;
            uploadButton.textContent = 'ä¸Šä¼ ä¸­...';

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        showStatus(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${file.name}`, 'success');
                    } else {
                        throw new Error('ä¸Šä¼ å¤±è´¥');
                    }
                } catch (error) {
                    showStatus(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${file.name}`, 'error');
                }
            }

            // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
            selectedFiles = [];
            updateFileList();
            uploadButton.textContent = 'å¼€å§‹ä¸Šä¼ ';
        }
    </script>
</body>
</html>